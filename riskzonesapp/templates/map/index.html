{% extends 'base.html' %}

{% block htmlhead %}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>
{% endblock %}

{% block header %}
  {% block title %}Map{% endblock %}
{% endblock %}

{% block content %}
  <div class="map_ui">
    <div id="map"></div>
  
    <div class="mapform">
      <form action="{{ url_for('map.run') }}" method="POST">
        <input type="hidden" id="polygon" name="polygon" value="[]">
        <input type="hidden" id="center_lat" value="{{ lat }}">
        <input type="hidden" id="center_lon" value="{{ lon }}">

        <div class="mapform_inner">
          <button type="button" onclick="clearlastmarker();">Clear last marker</button>
          <button type="button" class="button_red" onclick="clearmap();">Clear map</button>
  
          <p style="text-align: center;"><strong>Settings</strong></p>

          <div class="mapform_inner_horizontal">
            <label for="zl">Zone lenght (zl):</label>
            <input type="text" id="zl" name="zl" size="5" value="30" required>
          </div>
  
          <p style="text-align: center;"><strong>Points of Interest (PoIs)</strong></p>
          
          <div class="mapform_inner_horizontal">
            <div>
              <input type="checkbox" id="poi_hospital" name="poi_hospital" value="1" checked>
              <label for="poi_hospital">Hospitals</label>
            </div>
            <div>
              <label for="w_hospital">f(p):</label>
              <input type="text" id="w_hospital" name="w_hospital" value="10" size="2" required>
            </div>
          </div>
          
          <div class="mapform_inner_horizontal">
            <div>
              <input type="checkbox" id="poi_firedept" name="poi_firedept" value="1" checked>
              <label for="poi_firedept">Fire Stations</label>
            </div>
            <div>
              <label for="w_firedept">f(p):</label>
              <input type="text" id="w_firedept" name="w_firedept" value="5" size="2" required>
            </div>
          </div>
          
          <div class="mapform_inner_horizontal">
            <div>
              <input type="checkbox" id="poi_police"   name="poi_police"   value="1" checked>
              <label for="poi_police">Police Stations</label>
            </div>
            <div>
              <label for="w_police">f(p):</label>
              <input type="text" id="w_police" name="w_police" value="2" size="2" required>
            </div>
          </div>

          <div class="mapform_inner_horizontal">
            <div>
              <input type="checkbox" id="poi_metro"   name="poi_metro"   value="1">
              <label for="poi_metro">Metro Stations</label>
            </div>
            <div>
              <label for="w_metro">f(p):</label>
              <input type="text" id="w_metro" name="w_metro" value="1" size="2" required>
            </div>
          </div>

          <button type="submit">Request map</button>
        </div>
      </form>
    </div>

  </div>

  <script>
    const center_lat = parseFloat(document.getElementById('center_lat').value);
    const center_lon = parseFloat(document.getElementById('center_lon').value);
    const map = L.map('map').setView([center_lat, center_lon], 13);
    const markers = [];
    const polpoints = [];
    
    let polygon = null;
    let closed = false;
  
    const tiles = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    /**
     *  Clear map function.
     *
     *  Clears the map markings (markers and polygon).
     */
    function clearmap() {
      if (polygon) {
        map.removeLayer(polygon);
        polygon = null;
      }
      
      while (markers.length > 0) {
        marker = markers.pop();
        map.removeLayer(marker);
      }

      while (polpoints.length > 0) {
        polpoints.pop();
      }

      closed = false;
    }

    /**
     *  Clear last marker function.
     *
     *  Clears the last marker on the map. Works like an undo button.
     */
    function clearlastmarker() {
      if (markers.length > 0) {
        marker = markers.pop();
        polpoints.pop();
        map.removeLayer(marker);
      }
      
      if (polygon) {
        map.removeLayer(polygon);
        polygon = null;
        closed = false;
      }
    }

    /**
     *  Click event.
     *  
     *  Whenever a user clicks on the map, the app should add the corresponding
     *  coordiniates to create a list of points that will generate a polygon
     *  for AoI selection.
    */
    function onMapClick(e) {
      // If the polygon is already closed, we don't allow more points
      if (closed == true) {
        return;
      }

      const lat = e.latlng['lat']
      const lon = e.latlng['lng']

      // Push the coordinates to our polygon list
      polpoints.push({
        'lat': lat,
        'lon': lon
      });

      // Creates a marker
      let marker = L.marker([lat, lon]).addTo(map);
      markers.push(marker);

      // Ther first marker gets a click event to close the polygon
      if (markers.length == 1) {
        marker.on('click', (e) => {
          html_polygon = document.getElementById('polygon');
          let str_polygon = '';
  
          for (let i = 0; i < polpoints.length - 1; i++) {
            str_polygon = str_polygon + '[' + polpoints[i]['lon'] + ', ' + polpoints[i]['lat'] + '], ';
          }
          let i = polpoints.length - 1;
          str_polygon = str_polygon + '[' + polpoints[i]['lon'] + ', ' + polpoints[i]['lat'] + ']';
  
          document.getElementById('polygon').value = '[' + str_polygon + ']';
          polygon = L.polygon([...polpoints]).addTo(map);
          closed = true;
        });
      }
    }
  
    map.on('click', onMapClick);
  </script>
{% endblock %}
